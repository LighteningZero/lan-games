<!DOCTYPE html>
<html>

<head>
    <title>WS Chat</title>
    <script src="./jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="./style.css" />
</head>

<body onload="init()">
    <textarea id="message" disabled></textarea>
    <textarea id="send" placeholder="Say something" spellcheck="false"></textarea>
    <div class="top-box">
        <button class="send-button" onclick="clear_message()">Clear</button>
        <p><input id="scroll-option" type="checkbox" checked /> Enable auto scroll</p>
        <p>Version WS_0.1</p>
    </div>
    <div class="bottom-box">
        <span class="note">Press Ctrl + Enter to send </span>
        <button class="send-button" onclick="send()">Send</button>
    </div>

    <script>
        let ws;
        let username;
        let time_stamp = 0;
        let ip = new String("ws://172.32.5.177:8010/chat");

        function clear_message() {
            $("#message").val("");
        }

        function write_message(msg) {
            $("#message").val($("#message").val() + msg + "\n\n");
            scroll_to_bottom();
        }

        function init() {
            clear_message();
            login();
            ws = new WebSocket(ip);

            ws.onopen = function () {
                write_message("[INFO] Connect to server.");
                ws.send("/rename " + username);
            };

            ws.onmessage = function (evt) {
                write_message(evt.data);
            };

            ws.onclose = function () {
                write_message("[INFO] Disconnected.");
            };
        }

        function login() {
            let input_ip = window.prompt("[Connect] Input server");
            if (input_ip !== null) {
                ip = input_ip;
            }
            username = window.prompt("[Login] Input your name");
        }

        function send() {
            let data = $("#send").val();
            if (data == "/clear") {
                clear_message();
                return;
            }

            if (ws.readyState == 1) {
                ws.send(data);
            } else {
                write_message("[INFO] Unknow error while sending message.");
            }

            $("#send").val("");
        }

        function scroll_to_bottom() {
            if ($("#scroll-option").is(":checked")) {
                document.getElementById("message").scrollTop = document.getElementById("message").scrollHeight;
            }
        }

        $(document).ready(
            function () {
                document.onkeydown = function () {
                    let key_event = window.event;
                    if (key_event.keyCode == 13 && key_event.ctrlKey) {
                        send();
                    }
                }
            }
        );  
    </script>
</body>

</html>